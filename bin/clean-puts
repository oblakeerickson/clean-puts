#!/usr/bin/env ruby

require 'optparse'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: clean-puts [options]"

  opts.on("-h", "--help", "Prints help") do
    puts opts
    exit
  end
end.parse!

diff = `git diff --unified=0 -G'puts'`

## Example:
# diff --git a/file.rb b/file.rb
def get_filename(line)
  parts = line.split(" ")
  filename_b = parts[3]
  filename_b[2..-1]
end

## Example
# @@ -12,0 +13 @@
#TODO: Handle when puts was added to existing blank line
def get_linenumber(line)
  parts = line.split(' ')
  parts[2].to_i
end

store = {}

filename = nil

diff.each_line do |d|
  if d.include? "diff --git"
    filename_line = d
    filename = get_filename(filename_line)
    store[filename] = []
  end
  if d.match(/^@@.*@@.*$/)
    linenumber_line = d
    if store.has_key? filename
      store[filename] << get_linenumber(linenumber_line)
    end
  end
end

store.each do |f, v|
  v.each_with_index do |n, i|
    `sed -i '#{n-i}d' #{f}`
  end
end
